# 配置系统使用说明

## 概述

本项目已将原本分散在各个模块中的硬编码配置项统一迁移到 `config/config.py` 文件中进行集中管理。这样做的好处包括：

- **统一管理**：所有配置项集中在一个文件中，便于查找和修改
- **类型安全**：通过类结构组织配置，提供更好的代码提示和类型检查
- **文档化**：每个配置项都有详细的注释说明
- **验证机制**：内置配置验证功能，确保配置值的有效性
- **动态更新**：支持运行时动态修改配置项

## 配置文件结构

配置文件 `config/config.py` 按功能模块组织，包含以下配置类：

### 1. WebSocketConfig - WebSocket相关配置

```python
class WebSocketConfig:
    ORDER_CHECK_INTERVAL = 5.0         # 主动检查间隔（秒）
    ORDER_WATCH_TIMEOUT = 30.0         # 订单监听超时时间（秒）
```

**影响的模块**：`core/websocketManager.py`

### 2. TradeConfig - 交易相关配置

```python
class TradeConfig:
    # 基于成交价的基准价功能
    USE_TRANSACTION_PRICE = True        # 是否使用成交价作为基准价的开关
    
    # 订单状态监控和恢复机制
    NO_ORDER_TIMEOUT = 60.0            # 无订单超时时间（秒）
    ORDER_CHECK_INTERVAL = 30.0        # 订单检查间隔（秒）
    
    # 默认交易参数（可被symbols.json中的配置覆盖）
    DEFAULT_BASE_SPREAD = 0.001         # 默认基础价差
    DEFAULT_MIN_SPREAD = 0.0008         # 默认最小价差
    DEFAULT_MAX_SPREAD = 0.003          # 默认最大价差
    DEFAULT_ORDER_COOL_DOWN = 0.1       # 默认下单冷却时间（秒）
    DEFAULT_MAX_STOCK_RATIO = 0.25      # 默认最大持仓比例
    DEFAULT_ORDER_AMOUNT_RATIO = 0.05   # 默认订单金额比例
    DEFAULT_COIN = 'USDT'               # 默认计价币种
    DEFAULT_DIRECTION = 'both'          # 默认交易方向
    
    # 交易风控参数
    MIN_ORDER_VALUE = 5.5               # 最小订单价值（USDT）
    PRICE_DEVIATION_FACTOR = 0.5        # 价格偏差阈值系数（相对于基础价差）
```

**影响的模块**：`core/tradeManager.py`

### 3. DataRecorderConfig - 数据记录相关配置

```python
class DataRecorderConfig:
    RECORD_INTERVAL = 60                # 数据记录间隔（秒）
    MAX_CACHE_SIZE = 1000              # 最大缓存大小
    AUTO_FLUSH_INTERVAL = 300          # 自动刷新间隔（秒）
```

**影响的模块**：`core/dataRecorder.py`

### 4. ChartConfig - 图表相关配置

```python
class ChartConfig:
    CHART_UPDATE_INTERVAL = 30          # 图表更新间隔（秒）
    MAX_DATA_POINTS = 500              # 图表最大数据点数
    CHART_WIDTH = 1200                 # 图表宽度
    CHART_HEIGHT = 600                 # 图表高度
```

**影响的模块**：`core/chartManager.py`

### 5. NetworkConfig - 网络相关配置

```python
class NetworkConfig:
    MAX_RETRY_ATTEMPTS = 3             # 最大重试次数
    RETRY_DELAY = 1.0                  # 重试延迟（秒）
    CONNECTION_TIMEOUT = 30.0          # 连接超时时间（秒）
    READ_TIMEOUT = 60.0               # 读取超时时间（秒）
    
    # WebSocket重连配置
    WS_RECONNECT_DELAY = 5.0          # WebSocket重连延迟（秒）
    WS_MAX_RECONNECT_ATTEMPTS = 10    # WebSocket最大重连次数
```

### 6. LogConfig - 日志相关配置

```python
class LogConfig:
    LOG_LEVEL = 'INFO'                 # 日志级别
    LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    LOG_DATE_FORMAT = '%Y-%m-%d %H:%M:%S'
    
    # 日志文件配置
    LOG_FILE_MAX_SIZE = 10 * 1024 * 1024  # 日志文件最大大小（字节）
    LOG_FILE_BACKUP_COUNT = 5          # 日志文件备份数量
    LOG_TO_FILE = True                 # 是否写入文件
    LOG_TO_CONSOLE = True              # 是否输出到控制台
```

**影响的模块**：`util/sLogger.py`

### 7. SystemConfig - 系统相关配置

```python
class SystemConfig:
    GRACEFUL_SHUTDOWN_TIMEOUT = 30.0   # 优雅关闭超时时间（秒）
    TASK_CLEANUP_TIMEOUT = 10.0        # 任务清理超时时间（秒）
    
    # 内存和性能配置
    MAX_MEMORY_USAGE = 512 * 1024 * 1024  # 最大内存使用量（字节）
    GC_THRESHOLD = 100                 # 垃圾回收阈值
```

### 8. SecurityConfig - 安全相关配置

```python
class SecurityConfig:
    API_RATE_LIMIT = 100               # API调用频率限制（次/分钟）
    MAX_POSITION_SIZE = 1000000        # 最大持仓大小限制
    MAX_ORDER_SIZE = 100000            # 最大订单大小限制
    
    # 风险控制配置
    DAILY_LOSS_LIMIT = 0.05            # 日损失限制（比例）
    MAX_DRAWDOWN_LIMIT = 0.10          # 最大回撤限制（比例）
```

## 使用方法

### 1. 读取配置

在代码中使用配置项：

```python
from config.config import get_trade_config, get_websocket_config

# 获取交易配置
trade_config = get_trade_config()
use_transaction_price = trade_config.USE_TRANSACTION_PRICE
min_order_value = trade_config.MIN_ORDER_VALUE

# 获取WebSocket配置
ws_config = get_websocket_config()
order_check_interval = ws_config.ORDER_CHECK_INTERVAL
```

### 2. 修改配置

#### 方法一：直接修改配置文件

编辑 `config/config.py` 文件，修改相应的配置值：

```python
class TradeConfig:
    USE_TRANSACTION_PRICE = False  # 修改为False
    MIN_ORDER_VALUE = 10.0         # 修改最小订单价值
```

#### 方法二：运行时动态修改

```python
from config.config import update_config

# 动态更新配置
update_config('TradeConfig', 'USE_TRANSACTION_PRICE', False)
update_config('TradeConfig', 'MIN_ORDER_VALUE', 10.0)
```

### 3. 配置验证

系统提供配置验证功能，确保配置值的有效性：

```python
from config.config import validate_config

try:
    validate_config()
    print("配置验证通过")
except ValueError as e:
    print(f"配置验证失败: {e}")
```

### 4. 导出配置

可以将当前配置导出为字典格式：

```python
from config.config import export_config_to_dict

config_dict = export_config_to_dict()
print(config_dict)
```

## 迁移说明

以下是已迁移的配置项对照表：

| 原位置 | 原变量名 | 新位置 | 新变量名 |
|--------|----------|--------|----------|
| `websocketManager.py` | `self.orderCheckInterval = 5.0` | `WebSocketConfig` | `ORDER_CHECK_INTERVAL` |
| `websocketManager.py` | `self.orderWatchTimeout = 30.0` | `WebSocketConfig` | `ORDER_WATCH_TIMEOUT` |
| `tradeManager.py` | `self.useTransactionPrice = True` | `TradeConfig` | `USE_TRANSACTION_PRICE` |
| `tradeManager.py` | `self.noOrderTimeout = 60.0` | `TradeConfig` | `NO_ORDER_TIMEOUT` |
| `tradeManager.py` | `self.orderCheckInterval = 30.0` | `TradeConfig` | `ORDER_CHECK_INTERVAL` |
| `tradeManager.py` | `minOrderValue = 5.5` | `TradeConfig` | `MIN_ORDER_VALUE` |
| `tradeManager.py` | `price_deviation_threshold = self.baseSpread * 0.5` | `TradeConfig` | `PRICE_DEVIATION_FACTOR` |
| `chartManager.py` | `update_interval=3000` | `ChartConfig` | `CHART_UPDATE_INTERVAL` |
| `chartManager.py` | `figsize=(10, 8)` | `ChartConfig` | `CHART_WIDTH`, `CHART_HEIGHT` |
| `sLogger.py` | `max_bytes=10 * 1024 * 1024` | `LogConfig` | `LOG_FILE_MAX_SIZE` |
| `sLogger.py` | `backup_count=5` | `LogConfig` | `LOG_FILE_BACKUP_COUNT` |
| `sLogger.py` | 日志格式字符串 | `LogConfig` | `LOG_FORMAT`, `LOG_DATE_FORMAT` |

## 注意事项

1. **向后兼容性**：现有的 `symbols.json` 配置文件仍然有效，其中的配置会覆盖 `config.py` 中的默认值

2. **配置优先级**：
   - `symbols.json` 中的交易对特定配置 > `config.py` 中的默认配置
   - 函数参数 > 配置文件中的值

3. **重启要求**：修改配置文件后，需要重启程序才能生效（除非使用动态更新功能）

4. **配置验证**：系统会在启动时自动验证配置的有效性，如果配置无效会抛出异常

5. **扩展性**：如需添加新的配置项，请按照现有的结构在相应的配置类中添加，并更新相关的验证逻辑

## 常见问题

### Q: 如何添加新的配置项？

A: 在 `config.py` 的相应配置类中添加新的类属性，并在验证函数中添加相应的验证逻辑。

### Q: 配置修改后为什么没有生效？

A: 请确保：
1. 配置文件语法正确
2. 重启了程序
3. 没有被 `symbols.json` 中的配置覆盖

### Q: 如何恢复默认配置？

A: 可以从版本控制系统中恢复 `config.py` 文件，或者参考本文档中的默认值手动修改。

### Q: 配置验证失败怎么办？

A: 检查错误信息，修正相应的配置值。常见问题包括：
- 数值超出有效范围
- 必需的配置项缺失
- 配置类型不正确

## 总结

通过统一的配置管理系统，项目的可维护性和可配置性得到了显著提升。用户可以更方便地调整系统行为，开发者也能更容易地添加新的配置选项。建议在修改配置前先备份原始配置，并在测试环境中验证配置的有效性。