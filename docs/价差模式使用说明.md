# 价差模式使用说明

## 概述

为了解决基于AS模型的网格交易系统亏损问题，我们实现了多种价差模式，允许用户根据市场情况和风险偏好选择合适的价差策略。

## 问题背景

原有的AS（Avellaneda-Stoikov）模型通过动态调整价差来管理库存风险，但在某些市场条件下可能导致：
- 库存以低于成本价被抛售
- 持续亏损，特别是在震荡市场中
- 风险控制与盈利能力的平衡问题

## 解决方案

### 三种价差模式

#### 1. 固定价差模式 (Fixed)
- **特点**: 始终使用固定的买卖价差
- **优点**: 简单可靠，避免低价抛售
- **缺点**: 缺乏库存管理能力
- **适用场景**: 追求稳定盈利，风险厌恶型策略

#### 2. 动态价差模式 (Dynamic)
- **特点**: 保留原有AS模型的完整逻辑
- **优点**: 具备库存管理和风险控制能力
- **缺点**: 可能在某些情况下导致亏损
- **适用场景**: 专业交易者，能承受一定风险

#### 3. 混合价差模式 (Hybrid)
- **特点**: 根据库存水平智能切换价差策略
- **优点**: 平衡盈利能力和风险控制
- **缺点**: 配置相对复杂
- **适用场景**: 大多数用户的推荐选择

## 配置参数

### 基础配置

在 `config/config.py` 的 `TradeConfig` 类中：

```python
# 价差模式选择
SPREAD_MODE = 'fixed'  # 可选: 'fixed', 'dynamic', 'hybrid'

# 混合模式阈值配置
INVENTORY_SAFE_THRESHOLD = 0.4    # 安全库存阈值
INVENTORY_RISK_THRESHOLD = 0.7    # 风险库存阈值

# 成本价保护（未来功能）
ENABLE_COST_PROTECTION = False    # 是否启用成本价保护
MAX_LOSS_RATIO = 0.02            # 最大允许亏损比例
MIN_PROFIT_RATIO = 0.001         # 最小利润比例
```

### 混合模式详细说明

混合模式根据当前库存比例自动选择价差策略：

- **库存比例 < INVENTORY_SAFE_THRESHOLD (0.4)**
  - 使用固定价差模式
  - 确保稳定盈利

- **库存比例 >= INVENTORY_RISK_THRESHOLD (0.7)**
  - 使用动态价差模式
  - 积极管理库存风险

- **INVENTORY_SAFE_THRESHOLD <= 库存比例 < INVENTORY_RISK_THRESHOLD**
  - 线性插值过渡
  - 平滑切换，避免价格跳跃

## 使用建议

### 新手用户
```python
SPREAD_MODE = 'fixed'
```
- 简单安全，避免复杂的风险管理
- 适合小资金量和保守策略

### 进阶用户
```python
SPREAD_MODE = 'hybrid'
INVENTORY_SAFE_THRESHOLD = 0.3
INVENTORY_RISK_THRESHOLD = 0.6
```
- 平衡盈利和风险控制
- 可根据个人风险偏好调整阈值

### 专业用户
```python
SPREAD_MODE = 'dynamic'
```
- 完整的AS模型功能
- 需要深入理解市场微观结构

## 监控和调试

### 日志信息

系统会记录详细的价差模式信息：

```
2025-08-06 12:36:53 - trade - INFO - BTC/USDT:USDT 模式:hybrid, 持仓比例:0.4500, 买单价差:0.000495, 卖单价差:0.000550
```

### 关键指标

- **持仓比例**: 当前库存占最大允许库存的比例
- **买单价差**: 买单相对于基准价的价差
- **卖单价差**: 卖单相对于基准价的价差
- **模式状态**: 当前使用的价差模式

## 风险提示

1. **配置变更风险**: 修改价差模式可能影响现有订单和持仓
2. **市场适应性**: 不同模式适用于不同的市场环境
3. **参数调优**: 混合模式的阈值需要根据实际交易情况调整
4. **回测验证**: 建议在实盘使用前进行充分的回测验证

## 未来功能

- **成本价保护**: 防止低于成本价卖出
- **动态阈值**: 根据市场波动率自动调整阈值
- **多时间框架**: 支持不同时间框架的价差策略
- **机器学习优化**: 基于历史数据优化参数

## 技术支持

如遇到问题，请检查：
1. 配置文件语法是否正确
2. 日志中的错误信息
3. 持仓和订单状态是否正常
4. 网络连接是否稳定

---

*最后更新: 2025-08-06*
*版本: 1.0.0*