# GLFT网格交易实时监控功能说明

## 功能概述

本项目新增了实时监控和绘图功能，能够在程序运行时实时记录和显示交易数据，包括：

- **实时数据记录**：自动记录所有交易对的成交订单、成交量、手续费
- **账户权益监控**：实时跟踪USDT权益变化
- **可视化图表**：在独立窗口中实时绘制多组折线图
- **数据统计**：提供详细的交易统计信息

## 核心组件

### 1. 数据记录器 (DataRecorder)

**文件位置**: `core/dataRecorder.py`

**主要功能**:
- 记录每笔交易的详细信息（交易对、方向、数量、价格、手续费）
- 跟踪账户USDT权益变化
- 计算累计成交量和手续费
- 提供数据查询接口

**核心方法**:
```python
# 记录交易数据
await data_recorder.record_trade(
    symbol="BTC/USDT:USDT",
    side="buy",
    amount=0.1,
    price=45000.0,
    fee=4.5,
    order_id="12345"
)

# 更新账户权益
await data_recorder.update_equity(1000.0)

# 获取统计数据
summary = data_recorder.get_summary()
```

### 2. 图表管理器 (ChartManager)

**文件位置**: `core/chartManager.py`

**主要功能**:
- 在独立线程中运行matplotlib图表
- 实时更新图表数据
- 支持中文显示
- 自动调整坐标轴范围

**显示内容**:

#### 第一组折线图：账户权益监控
- 🔵 **账户权益折线**：显示USDT权益的实时变化
- 🔴 **累计手续费折线**：显示所有交易对累计产生的手续费
- 🟢 **权益+50%手续费折线**：显示账户权益与50%手续费之和

#### 第二组折线图：成交量监控
- 🟣 **累计成交量折线**：显示所有交易对的累计成交量

## 集成方式

### 1. 自动集成

新功能已自动集成到现有的交易系统中：

- **TradeManager**: 在`onOrderFilled()`方法中自动记录成交数据
- **TradeManager**: 在`updateBalance()`方法中自动更新权益数据
- **main.py**: 程序启动时自动启动图表管理器

### 2. 手动控制

```python
from core.chartManager import chart_manager
from core.dataRecorder import data_recorder

# 启动图表
chart_manager.start_charts()

# 停止图表
chart_manager.stop_charts()

# 保存图表
chart_manager.save_chart("my_chart.png")
```

## 使用指南

### 1. 正常运行

直接运行主程序，监控功能会自动启动：

```bash
python main.py
```

程序启动后会：
1. 自动弹出监控图表窗口
2. 开始实时记录交易数据
3. 实时更新图表显示

### 2. 测试功能

运行测试脚本验证监控功能：

```bash
python tests/test_监控功能.py
```

测试脚本会：
1. 生成模拟交易数据
2. 显示实时图表
3. 演示所有监控功能

### 3. 图表操作

- **缩放**：使用鼠标滚轮或工具栏缩放按钮
- **平移**：按住鼠标左键拖动
- **保存**：使用工具栏保存按钮或程序接口
- **重置视图**：使用工具栏主页按钮

## 数据结构

### 交易记录 (TradeRecord)

```python
@dataclass
class TradeRecord:
    timestamp: float        # 时间戳
    symbol: str            # 交易对
    side: str              # 买卖方向 ('buy' or 'sell')
    amount: float          # 成交数量
    price: float           # 成交价格
    fee: float             # 手续费
    order_id: str          # 订单ID
```

### 账户快照 (AccountSnapshot)

```python
@dataclass
class AccountSnapshot:
    timestamp: float           # 时间戳
    usdt_equity: float        # USDT权益
    total_fee: float          # 累计手续费
    total_volume: float       # 累计成交量
    equity_plus_half_fee: float # 权益+50%手续费
```

## 性能优化

### 1. 内存管理

- 自动限制历史数据长度（最多10000条记录）
- 超出限制时自动清理旧数据
- 使用异步锁避免数据竞争

### 2. 图表更新

- 默认2秒更新间隔，可调整
- 独立线程运行，不影响交易逻辑
- 智能时间轴格式化

### 3. 错误处理

- 完善的异常捕获和日志记录
- 监控功能异常不影响交易主流程
- 自动重试机制

## 配置选项

### 图表更新间隔

```python
# 修改更新间隔（毫秒）
chart_manager = ChartManager(update_interval=1000)  # 1秒更新
```

### 数据记录限制

```python
# 在 dataRecorder.py 中修改
if len(self.account_snapshots) > 10000:  # 修改此数值
    self.account_snapshots = self.account_snapshots[-5000:]
```

## 故障排除

### 1. 图表不显示

**可能原因**:
- matplotlib后端配置问题
- 缺少GUI支持

**解决方案**:
```python
import matplotlib
matplotlib.use('TkAgg')  # 或 'Qt5Agg'
```

### 2. 中文显示乱码

**解决方案**:
- 确保系统安装了中文字体
- 修改字体配置：

```python
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei']
```

### 3. 内存占用过高

**解决方案**:
- 减少历史数据保存数量
- 增加图表更新间隔
- 定期重启程序

## 扩展功能

### 1. 添加新的图表

```python
# 在 chartManager.py 中添加新的子图
self.fig, self.axes = plt.subplots(3, 1, figsize=(12, 15))  # 增加到3个子图
```

### 2. 导出数据

```python
# 获取原始数据
account_data = data_recorder.get_account_data()
trade_records = data_recorder.trade_records

# 导出到CSV
import pandas as pd
df = pd.DataFrame([record.__dict__ for record in trade_records])
df.to_csv('trade_history.csv', index=False)
```

### 3. 添加报警功能

```python
# 添加数据更新回调
def check_alerts():
    summary = data_recorder.get_summary()
    if summary['total_fee'] > 100:  # 手续费超过100 USDT
        logger.warning("手续费过高警告！")

data_recorder.add_data_update_callback(check_alerts)
```

## 注意事项

1. **线程安全**：所有数据操作都使用了异步锁，确保线程安全
2. **资源清理**：程序退出时会自动清理图表线程和数据记录器
3. **错误隔离**：监控功能的异常不会影响主要的交易逻辑
4. **性能影响**：监控功能对交易性能的影响微乎其微
5. **数据持久化**：当前版本数据仅保存在内存中，程序重启后数据会丢失

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实时交易数据记录
- ✅ 账户权益监控
- ✅ 双组折线图显示
- ✅ 自动集成到现有系统
- ✅ 完整的测试脚本
- ✅ 中文界面支持

### 计划功能
- 📋 数据持久化存储
- 📋 更多图表类型（K线图、饼图等）
- 📋 Web界面支持
- 📋 报警和通知功能
- 📋 历史数据分析工具