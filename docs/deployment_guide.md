# 订单监听修复部署指南

## 概述

本指南提供了安全部署订单监听修复的详细步骤，确保程序能够稳定运行并避免长时间停止监听的问题。

## 修复内容总结

### 1. 核心问题修复
- **onOrderFilled方法异常处理**: 修复了当`filled_orders`为`None`时导致程序崩溃的问题
- **订单监听状态检查**: 新增`isOrderWatchActive`方法检查监听状态
- **自动恢复机制**: 新增`checkAndRecoverOrderWatch`方法自动恢复订单监听
- **定期检查机制**: 在价格更新中添加定期检查，确保监听状态正常

### 2. 修改的文件
- `core/tradeManager.py`: 主要修复文件
- `core/websocketManager.py`: 辅助修复文件

## 部署前准备

### 1. 备份当前版本
```bash
# 创建备份目录
mkdir backup_$(date +%Y%m%d_%H%M%S)

# 备份关键文件
cp core/tradeManager.py backup_*/
cp core/websocketManager.py backup_*/
cp logs/trade_*.log backup_*/
```

### 2. 验证当前程序状态
- 确保程序已停止运行
- 检查是否有未成交订单需要手动处理
- 记录当前账户余额和持仓状态

## 部署步骤

### 第一步：应用代码修复

修复已经通过工具自动应用到以下文件：
- `f:\api\GLFT-Grid-Python\core\tradeManager.py`
- `f:\api\GLFT-Grid-Python\core\websocketManager.py`

### 第二步：运行测试验证

```bash
# 运行修复测试脚本
python test_order_monitoring_fix.py
```

预期输出：
```
订单监听修复测试脚本
==================================================
开始运行订单监听修复测试
测试onOrderFilled方法处理None参数
✅ onOrderFilled(None) 测试通过
✅ onOrderFilled([]) 测试通过
测试websocketManager的订单监听状态检查
✅ 初始状态检查通过
✅ 启动监听状态检查通过
✅ 停止监听状态检查通过
测试订单监听检查和恢复机制
✅ 订单监听恢复机制测试通过
测试价格更新计数器和定期检查机制
✅ 价格更新计数器测试通过
🎉 所有测试通过！修复效果良好

✅ 测试完成，修复验证成功！
```

### 第三步：配置监控参数（可选）

在`config.json`中可以添加以下监控参数：

```json
{
  "monitoring": {
    "price_update_check_interval": 100,
    "order_watch_recovery_delay": 1,
    "max_recovery_attempts": 3
  }
}
```

### 第四步：启动程序

```bash
# 启动程序
python main.py
```

## 部署后验证

### 1. 日志监控

关注以下关键日志信息：

```bash
# 实时监控日志
tail -f logs/trade_*.log | grep -E "(订单监听|onOrderFilled|checkAndRecoverOrderWatch|异常恢复)"
```

### 2. 关键指标检查

- **订单监听状态**: 确保程序能正常监听订单成交
- **异常恢复**: 观察程序在遇到异常时是否能自动恢复
- **定期检查**: 每100次价格更新后是否执行状态检查

### 3. 功能验证清单

- [ ] 程序启动正常
- [ ] WebSocket连接建立成功
- [ ] 订单下达和监听正常
- [ ] 订单成交后能正确处理
- [ ] 异常情况下能自动恢复
- [ ] 长时间运行稳定（建议观察至少2小时）

## 监控和维护

### 1. 日常监控

- 每日检查日志文件，关注异常信息
- 监控程序运行时间，确保无长时间停止
- 定期检查账户余额和持仓变化

### 2. 异常处理

如果发现以下情况，请立即检查：

- 程序超过10分钟无订单活动
- 日志中出现大量异常信息
- 订单监听状态检查失败

### 3. 性能优化建议

- 定期清理旧日志文件
- 监控内存使用情况
- 根据交易频率调整检查间隔

## 回滚计划

如果修复后出现问题，可以按以下步骤回滚：

1. 停止当前程序
2. 恢复备份文件：
   ```bash
   cp backup_*/tradeManager.py core/
   cp backup_*/websocketManager.py core/
   ```
3. 重启程序
4. 报告问题详情

## 技术支持

如果在部署过程中遇到问题，请提供以下信息：

- 错误日志片段
- 程序运行环境信息
- 修复前后的行为对比
- 测试脚本运行结果

## 总结

本次修复主要解决了程序在订单成交后停止监听的问题，通过以下机制确保程序稳定运行：

1. **健壮的异常处理**: 防止程序因异常参数崩溃
2. **主动状态检查**: 定期检查订单监听状态
3. **自动恢复机制**: 检测到问题时自动恢复
4. **完善的日志记录**: 便于问题诊断和监控

按照本指南部署后，程序应该能够稳定运行，避免长时间停止监听的问题。