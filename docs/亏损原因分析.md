# 前言

该程序在运行中，不论价格涨跌，账户的已实现盈亏一直在下降，这是不正确的。如果是一个标准的网格交易（尤其是像本程序一样双向运行同时做多做空的网格），其已实现盈亏应该是不断增加的，变化的只有浮盈和浮亏。

# 标准网格交易

首先对标准网格交易的运行流程进行简单分析，假设一个只做多的场景。程序可能会首先划分一批网格：
编号 价格 数量
卖单 3 103 1
卖单 2 102 1
卖单 1 101 1
当前价格 100  
买单 1 99 1
买单 2 98 1
买单 3 97 1

## 推演

1. 当价格下跌至 99 时，买单 1 被成交，此时花费 99 价格购入了 1 的数量，与此同时，会在上一个当前价格（即 100）处挂上一个新的卖单卖出 1 数量，如果价格又回到 100，则会将买单 1 购入的数量卖出，获利 100-99=1 元。
2. 如果价格大幅下跌至 97，此时分批购入了 3 个数量，并且按照上述的逻辑进行挂卖单，如果价格又涨回到 100，将会按照'卖出买单 3'-->卖出买单 2-->卖出买单 1 的顺序进行卖出。
3. 如果价格大幅下跌至 97，接着涨回 99，又下跌至于 97，最终涨回 100，程序将按照以下顺序运行：'99 买入买单 1'-->'98 买入买单 2'-->'97 买入买单 3'-->'98 卖出买单 3'-->'99 卖出买单 2'-->'98 买入买单 2'-->'97 买入买单 3'-->'98 卖出买单 3'-->'99 卖出买单 2'-->'100 卖出买单 1'

## 结论

从以上 3 次推演可以得出以下结论：

1. 在网格间距比手续费高的情况下，一个正常的网格交易的已实现盈亏是一定在不断增长的，只有浮盈浮亏会发生变化。
2. **网格交易本质上是一个先进后出的堆栈，在第 3 个推演中，价格在 97 到 99 之间震荡，但在 99 处买入的买单 1，一定是等到价格重新涨回 100 才被成交**

# 本程序的网格交易变体

本程序是一个基于 AS 库存管理模型的动态网格交易策略，它不会像标准网格交易那样一次性挂上许多订单，而是同时只会在距离中间价最近的买卖单位置挂上订单，并在有订单被成交后立即取消没有被成交的订单，然后重新计算中间价和买卖单位置，并重新挂上订单，反复循环这个过程。
并且本程序引入了库存管理模型，按照理论，当库存在做多方向较高时，程序会同时降低卖价和买价以促使卖出并降低买单成交率，当库存在做空方向较高时，程序会同时提高卖价和买价以促使买入并降低卖单成交率，从而维持库存在一个安全的水平。
AS 模型计算买卖单价格的详细可见'docs/AS 模型.md'

编号 价格 数量
卖单 1 101 1
中间价 100  
买单 1 99 1

## 推演

本程序的网格交易推演相对复杂。

### 场景 1

场景 1 是较为理想的情况：

1. 当价格下跌至 99，程序将会买入买单 1，并且挂单将会变成这样：
   卖单 1 99.9 1
   中间价 99  
   买单 1 97.9 1

由于库存在做多方向增加，程序会同时降低卖价和买价：在正常网格交易中应该被挂在 100 位置的卖单，被降低到了 99.9；在正常网格交易中应该被挂在 98 位置的买单，被降低到了 97.9。

2. 如果价格上涨达到 99.9，程序会将卖单 1 成交，并且挂单会变成这样：
   卖单 1 109.9
   中间价 99.9  
   买单 1 98.9

由于库存降低，程序将会回到上一轮的买卖价差，但是由于在 1.中卖单价格被降低了，因此该卖单被成交后后中间价也被降低了。

### 场景 2

场景 2 是较为现实的情况，假设此时价格已经大幅下跌，推演整个挂单过程：

卖单 101 1
中间价 100 库存 0
买单 99 1

---

卖单 99.9 1
中间价 99 库存 1
买单 97.9 1

---

卖单 98.7 1
中间价 97.9 库存 2
买单 96.7 1

---

卖单 97.4 1
中间价 96.7 库存 3
买单 95.4 1

---

卖单 96 1
中间价 95.4 库存 4
买单 94 1

---

现在价格已经跌至 95.4，手中也有了 4 数量的库存，接下来从这个价格开始推演价格上涨情况：

---

卖单 96.7 1
中间价 96 库存 3
买单 94.7 1

---

卖单 97.5 1
中间价 96.7 库存 2
买单 95.5 1

---

从这里开始就已经能发现问题了：在买入后应该在 97.4 被卖出的库存 3，却在 96.7 就被卖出了！而库存 3 的成本价是 96.7，等于这一单没有利润！
接下来继续：

---

卖单 98.4 1
中间价 97.5 库存 1
买单 96.4 1

---

从这里开始就能看出亏损的根源了！在买入后应该在 98.7 被卖出的库存 2，却在 97.5 就被卖出了！而库存 2 的成本价是 97.9，等于这一单不仅没有利润，还是亏损的！

---

卖单 99.4 1
中间价 98.4 库存 0
买单 97.4 1

---

这一单同样是亏损的（成本价 99，售出价 98.4），并且价格甚至都没有回到 100，库存就已经售完了！

## 结论

1. AS 库存管理模型旨在为做市商控制库存，但直接移植至网格交易中存在严重的问题，几乎必定会导致亏损！
2. 由于 AS 模型的价差管理机制，库存被以低于成本价抛售是产生亏损的核心原因。

# 总结分析

基于 AS 模型的网格交易变体有更好的库存管理能力，但几乎失去了盈利能力。

## 可能的解决方案

1. 加入动态价差开关，当关闭时，每一单的买卖单价差都固定为初始值
2. 只在库存较高时启用 AS 模型的动态价差，当库存水平正常时就像常规的网格交易那样保持固定的买卖单价差
